<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PRISMA ABYSS -Monster Master Editor- v4.3</title>
    <script src="monsters.js"></script>
    <script src="items.js"></script>
    <script src="skills.js"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        input, textarea, select { 
            background: #1e293b; color: #fff; border: 1px solid #334155; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 13px;
        }
        input:focus, select:focus { border-color: #f59e0b; outline: none; ring: 1px solid #f59e0b; }
        label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; font-weight: 600; }
        
        .sidebar { width: 340px; border-right: 1px solid #334155; background: #0f172a; }
        .monster-item:hover { background: #1e293b; }
        .monster-item.active { background: #1e3a8a; border-left: 4px solid #3b82f6; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 24px; background: #0f172a; }
        .section-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; text-align: center; }
        .btn-primary { background: #2563eb; color: white; border: 1px solid #3b82f6; }
        .btn-success { background: #059669; color: white; border: 1px solid #10b981; }
        .btn-warning { background: #d97706; color: white; border: 1px solid #f59e0b; }
        .btn-danger { background: #dc2626; color: white; border: 1px solid #ef4444; }

        .sticky-header { position: sticky; top: 0; z-index: 50; background: #0f172a; border-bottom: 1px solid #334155; }
        .export-box { width: 100%; height: 400px; background: #020617; color: #22d3ee; font-family: 'Fira Code', monospace; font-size: 12px; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #334155; overflow: auto; white-space: pre; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col h-screen">
    <header class="sticky-header px-6 py-4 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-black text-amber-500 tracking-tighter">PRISMA ABYSS <span class="text-slate-400 font-light text-base ml-2">Monster Editor 4.3</span></h1>
            <div class="flex gap-2">
                <div class="flex rounded-md shadow-sm overflow-hidden">
                    <button @click="downloadJS('pretty')" class="btn btn-warning rounded-r-none border-r border-amber-600">ğŸ’¾ JS (æ•´å½¢)</button>
                    <button @click="downloadJS('line')" class="btn btn-warning rounded-l-none text-[10px]">1è¡Œ/ID</button>
                </div>
                <button @click="exportCSV" class="btn btn-success">ğŸ“Š CSVå‡ºåŠ›</button>
                <button @click="triggerCSVImport" class="btn btn-primary">ğŸ“¥ CSVå–è¾¼</button>
            </div>
        </div>
        <div class="flex items-center gap-4 text-xs text-slate-400">
            Skills: {{db.SKILLS.length}} / Items: {{db.ITEMS.length}} / Monsters: {{db.MONSTERS.length}}
            <button @click="reloadData" class="ml-4 hover:text-white underline transition-colors">æœ€æ–°ãƒ‡ãƒ¼ã‚¿å†èª­è¾¼</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="sidebar flex flex-col shadow-inner">
            <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                <input type="text" v-model="monsterFilter" placeholder="åå‰ã¾ãŸã¯IDã§æ¤œç´¢..." class="placeholder-slate-500">
            </div>
            <div class="flex-1 overflow-y-auto">
                <div v-for="m in filteredMonsters" :key="m._uid" 
                     @click="selectMonster(m)"
                     :class="['monster-item p-4 cursor-pointer border-b border-slate-800 transition-all', selectedMonster && selectedMonster._uid === m._uid ? 'active' : '']">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono text-slate-500">#{{m.id}}</span>
                        <div class="flex gap-1">
                            <span v-if="m.isBoss" class="text-[9px] bg-rose-900/50 text-rose-200 px-1.5 py-0.5 rounded border border-rose-800 font-bold uppercase">BOSS</span>
                            <span v-if="m.isRare" class="text-[9px] bg-amber-900/50 text-amber-200 px-1.5 py-0.5 rounded border border-amber-800 font-bold uppercase">RARE</span>
                        </div>
                    </div>
                    <div class="font-bold truncate text-sm">{{m.name || '(åç§°æœªè¨­å®š)'}}</div>
                    <div class="flex gap-3 mt-2 text-[11px] text-slate-400">
                        <span>Rank: {{m.rank}}</span>
                        <span class="truncate max-w-[100px]">Race: {{m.race || 'ãªã—'}}</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <button @click="addMonster" class="btn btn-primary w-full py-3 shadow-lg">+ æ–°è¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¿½åŠ </button>
            </div>
        </aside>

        <main class="main-content" v-if="selectedMonster">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <div class="text-amber-500 font-mono text-sm mb-1 font-bold tracking-widest">MONSTER DATA #{{selectedMonster.id}}</div>
                    <h2 class="text-3xl font-black text-white leading-none">{{selectedMonster.name || 'UNNAMED'}}</h2>
                </div>
                <div class="flex gap-3">
                    <button @click="duplicateMonster" class="btn bg-slate-700 hover:bg-slate-600">è¤‡è£½ã—ã¦æ–°è¦ä½œæˆ</button>
                    <button @click="removeMonster" class="btn btn-danger">ã“ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å‰Šé™¤</button>
                </div>
            </div>

            <div class="flex gap-1 mb-6 border-b border-slate-800">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="activeTab = tab.id"
                    :class="['px-6 py-3 text-xs font-bold transition-all uppercase tracking-widest', activeTab === tab.id ? 'text-amber-500 border-b-2 border-amber-500 bg-slate-800/30' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/20']">
                    {{tab.name}}
                </button>
            </div>

            <div v-show="activeTab === 'basic'" class="space-y-6">
                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-8 section-card shadow-lg">
                        <h3 class="text-sm font-bold text-sky-400 mb-6 flex items-center gap-2 border-b border-slate-700 pb-4">åŸºæœ¬æƒ…å ± & æˆ¦é—˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="col-span-1"><label>ID (æ•°å€¤)</label><input type="number" step="0.001" v-model.number="selectedMonster.id"></div>
                            <div class="col-span-2"><label>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å</label><input type="text" v-model="selectedMonster.name"></div>
                            <div class="col-span-1">
                                <label>ç¨®æ— (race)</label>
                                <select v-model="selectedMonster.race">
                                    <option v-for="r in races" :key="r" :value="r">{{r}}</option>
                                </select>
                            </div>
                            
                            <div class="col-span-1"><label>ãƒ©ãƒ³ã‚¯ (rank)</label><input type="number" v-model.number="selectedMonster.rank"></div>
                            <div class="col-span-1"><label>é–‹å§‹éšå±¤ (minF)</label><input type="number" v-model.number="selectedMonster.minF"></div>
                            <div class="col-span-1"><label>çµŒé¨“å€¤ (exp)</label><input type="number" v-model.number="selectedMonster.exp"></div>
                            <div class="col-span-1"><label>ã‚´ãƒ¼ãƒ«ãƒ‰ (gold)</label><input type="number" v-model.number="selectedMonster.gold"></div>
                        </div>

                        <div class="grid grid-cols-5 gap-4 pt-6 border-t border-slate-700/50">
                            <div><label class="text-emerald-400">æœ€å¤§HP</label><input type="number" v-model.number="selectedMonster.hp"></div>
                            <div><label class="text-blue-400">æœ€å¤§MP</label><input type="number" v-model.number="selectedMonster.mp"></div>
                            <div><label>æ”»æ’ƒåŠ› (atk)</label><input type="number" v-model.number="selectedMonster.atk"></div>
                            <div><label>é˜²å¾¡åŠ› (def)</label><input type="number" v-model.number="selectedMonster.def"></div>
                            <div><label>ç´ æ—©ã• (spd)</label><input type="number" v-model.number="selectedMonster.spd"></div>
                            
                            <div><label>é­”åŠ› (mag)</label><input type="number" v-model.number="selectedMonster.mag"></div>
                            <div><label>é­”æ³•é˜²å¾¡ (mdef)</label><input type="number" v-model.number="selectedMonster.mdef"></div>
                            <div><label>å‘½ä¸­% (hit)</label><input type="number" v-model.number="selectedMonster.hit"></div>
                            <div><label>å›é¿% (eva)</label><input type="number" v-model.number="selectedMonster.eva"></div>
                            <div><label>ä¼šå¿ƒ% (cri)</label><input type="number" v-model.number="selectedMonster.cri"></div>
                        </div>
                    </div>

                    <div class="col-span-4 section-card shadow-lg">
                        <h3 class="text-sm font-bold text-violet-400 mb-6 flex items-center gap-2 border-b border-slate-700 pb-4">ãƒ•ãƒ©ã‚°ãƒ»ç‰¹æ€§ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h3>
                        <div class="space-y-3 mb-6">
                            <label class="flex items-center gap-3 cursor-pointer bg-slate-800/50 p-3 rounded-lg border border-slate-700 hover:border-slate-500">
                                <input type="checkbox" v-model="selectedMonster.isBoss" class="w-4 h-4 rounded text-rose-500">
                                <span class="text-sm font-bold">ãƒœã‚¹åˆ¤å®š (isBoss)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer bg-slate-800/50 p-3 rounded-lg border border-slate-700 hover:border-slate-500">
                                <input type="checkbox" v-model="selectedMonster.isRare" class="w-4 h-4 rounded text-amber-500">
                                <span class="text-sm font-bold">ãƒ¬ã‚¢åˆ¤å®š (isRare)</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer bg-slate-800/50 p-3 rounded-lg border border-slate-700 hover:border-slate-500">
                                <input type="checkbox" v-model="selectedMonster.isEstark" class="w-4 h-4 rounded text-purple-500">
                                <span class="text-sm font-bold">ã‚¨ã‚¹ã‚¿ãƒ¼ã‚¯å‹ (isEstark)</span>
                            </label>
                        </div>
                        <div class="mb-4">
                            <label>è¡Œå‹•å›æ•° (actCount)</label>
                            <input type="number" min="1" max="10" v-model.number="selectedMonster.actCount">
                        </div>
                        <div class="mb-4">
                            <label>ç‰¹æ€§ (traits) <span class="text-[10px] text-slate-500">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</span></label>
                            <input type="text" :value="traitsString" @input="updateTraits($event.target.value)" placeholder="ä¸æ­», æµ®éŠ, ç«œæ—...">
                        </div>
                        <div>
                            <label>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æƒ…å ± (archives) <span class="text-[10px] text-slate-500">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</span></label>
                            <input type="text" :value="archivesString" @input="updateArchives($event.target.value)" placeholder="å‡ºç¾ã‚¨ãƒªã‚¢, é–¢é€£ã‚¯ã‚¨ã‚¹ãƒˆåãªã©...">
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'acts'" class="section-card shadow-lg">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                    <h3 class="text-sm font-bold text-rose-400">AIè¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ (acts)</h3>
                    <button @click="addAct" class="btn btn-primary">+ æ–°è¦è¡Œå‹•ã‚’è¿½åŠ </button>
                </div>
                <div class="space-y-3">
                    <div v-for="(act, index) in selectedMonster.acts" :key="index" class="grid grid-cols-12 gap-3 items-end bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                        <div class="col-span-5">
                            <label>ã‚¹ã‚­ãƒ«å</label>
                            <select v-model.number="act.id">
                                <option :value="null">-- ã‚¹ã‚­ãƒ«ã‚’é¸æŠ --</option>
                                <option v-for="s in db.SKILLS" :value="s.id">[{{s.id}}] {{s.name}}</option>
                            </select>
                        </div>
                        <div class="col-span-2"><label>ç¢ºç‡ (%)</label><input type="number" v-model.number="act.rate"></div>
                        <div class="col-span-4"><label>æ¡ä»¶ã‚³ãƒ¼ãƒ‰ (0:å¸¸æ™‚, 1:HP50%, 2:HP25%, 3:ç‰¹æ®Š)</label><input type="number" v-model.number="act.condition"></div>
                        <div class="col-span-1"><button @click="selectedMonster.acts.splice(index, 1)" class="btn btn-danger w-full py-2">Ã—</button></div>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'drops'" class="section-card shadow-lg">
                <h3 class="text-sm font-bold text-emerald-400 mb-6 border-b border-slate-700 pb-4">ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ è¨­å®š</h3>
                <div class="grid grid-cols-2 gap-8">
                    <div class="bg-slate-800/40 p-6 rounded-2xl border border-slate-700 shadow-inner">
                        <h4 class="text-xs font-black uppercase tracking-widest text-slate-300 mb-4">é€šå¸¸ãƒ‰ãƒ­ãƒƒãƒ—</h4>
                        <div class="space-y-5">
                            <div>
                                <label>ã‚¢ã‚¤ãƒ†ãƒ </label>
                                <select v-model.number="monsterDropNormalId">
                                    <option :value="null">ãªã—</option>
                                    <option v-for="i in db.ITEMS" :value="i.id">[{{i.id}}] {{i.name}}</option>
                                </select>
                            </div>
                            <div><label>ãƒ‰ãƒ­ãƒƒãƒ—ç‡ (%)</label><input type="number" v-model.number="monsterDropNormalRate" step="0.1"></div>
                        </div>
                    </div>
                    <div class="bg-slate-800/40 p-6 rounded-2xl border border-slate-700 shadow-inner">
                        <h4 class="text-xs font-black uppercase tracking-widest text-amber-200 mb-4">ãƒ¬ã‚¢ãƒ‰ãƒ­ãƒƒãƒ—</h4>
                        <div class="space-y-5">
                            <div>
                                <label>ã‚¢ã‚¤ãƒ†ãƒ </label>
                                <select v-model.number="monsterDropRareId">
                                    <option :value="null">ãªã—</option>
                                    <option v-for="i in db.ITEMS" :value="i.id">[{{i.id}}] {{i.name}}</option>
                                </select>
                            </div>
                            <div><label>ãƒ‰ãƒ­ãƒƒãƒ—ç‡ (%)</label><input type="number" v-model.number="monsterDropRareRate" step="0.1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'resist'" class="space-y-6">
                <div class="section-card shadow-lg">
                    <h3 class="text-sm font-bold text-blue-400 mb-6 border-b border-slate-700 pb-4 flex justify-between">
                        <span>å±æ€§è€æ€§ (elmRes)</span>
                        <span class="text-[10px] text-slate-500">â€»ä»•æ§˜: 0=æ¨™æº–, 150=ç„¡åŠ¹, -50=å¼±ç‚¹</span>
                    </h3>
                    <div class="grid grid-cols-7 gap-3">
                        <div v-for="elm in ['ç«','æ°´','é¢¨','é›·','å…‰','é—‡','æ··æ²Œ']" :key="elm">
                            <label class="text-center block text-[10px] mb-2 font-bold">{{elm}}</label>
                            <input type="number" :value="selectedMonster.elmRes ? selectedMonster.elmRes[elm] : 0" @input="updateElmRes(elm, $event.target.value)" class="text-center">
                        </div>
                    </div>
                </div>
                <div class="section-card shadow-lg">
                    <h3 class="text-sm font-bold text-amber-400 mb-6 border-b border-slate-700 pb-4">çŠ¶æ…‹ç•°å¸¸è€æ€§ (resists)</h3>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
                        <div v-for="(label, key) in ailmentLabels" :key="key">
                            <label class="truncate text-[11px] font-bold">{{label}} ({{key}})</label>
                            <input type="number" :value="selectedMonster.resists ? selectedMonster.resists[key] : 0" @input="updateResist(key, $event.target.value)">
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <main class="main-content flex flex-col items-center justify-center text-slate-600" v-else>
            <div class="text-6xl mb-4 opacity-20">ğŸ‘¹</div>
            <p>å·¦ãƒ‘ãƒãƒ«ã‹ã‚‰ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ç·¨é›†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </main>
    </div>

    <div v-if="showExportArea" class="fixed inset-0 bg-slate-950/95 z-[100] p-10 flex flex-col backdrop-blur-md">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-amber-500 text-2xl font-black italic tracking-tighter uppercase">MONSTERS_DATA EXPORT ({{exportModeName}})</h2>
            <div class="flex gap-3">
                <button @click="copyToClipboard" class="btn btn-primary px-10">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                <button @click="showExportArea = false" class="btn btn-danger">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        <div class="export-box">{{exportText}}</div>
        <p class="text-slate-500 mt-4 text-xs font-mono tracking-widest">ã“ã‚Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ monsters.js ã® window.MONSTERS_DATA ã«ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const db = ref({ MONSTERS: [], SKILLS: [], ITEMS: [] });
        const selectedMonster = ref(null);
        const monsterFilter = ref("");
        const activeTab = ref("basic");
        const showExportArea = ref(false);
        const exportText = ref("");
        const exportModeName = ref("");

        const tabs = [
            { id: 'basic', name: 'Status' }, 
            { id: 'acts', name: 'Skills' }, 
            { id: 'drops', name: 'Drops' }, 
            { id: 'resist', name: 'Resists' }
        ];

        const ailmentLabels = { 
            Poison: "æ¯’", ToxicPoison: "çŒ›æ¯’", Shock: "éº»ç—º", Fear: "æ€¯ãˆ", 
            Seal: "å°å°", Curse: "å‘ªã„", Confusion: "æ··ä¹±", Charm: "é­…äº†", 
            Sleep: "çœ ã‚Š", InstantDeath: "å³æ­»", Debuff: "å¼±ä½“" 
        };
        
        // â‘  æŒ‡å®šã®ç¨®æ—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆ
        const races = ["ãªã—", "ã‚¸ã‚§ãƒªãƒ¼", "äºº", "ç„¡æ©Ÿç‰©", "ä¸æ­»è€…", "é­”æ—", "å‹•ç‰©", "ç£äºº", "æ©Ÿæ¢°", "ç«œ", "é³¥", "æµ·", "ç²¾éœŠ", "ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ"];

        const reloadData = () => {
            const raw = window.MONSTERS_DATA || [];
            db.value.MONSTERS = raw.map(m => {
                const mon = { ...m, _uid: Math.random().toString(36) };
                
                // è¡Œå‹•ã®æ­£è¦åŒ– (IDãƒªã‚¹ãƒˆã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã«å¤‰æ›)
                if (mon.acts && Array.isArray(mon.acts)) {
                    mon.acts = mon.acts.map(act => {
                        if (typeof act === 'number') return { id: act, rate: 10, condition: 0 };
                        return { id: act.id, rate: act.rate ?? 10, condition: act.condition ?? 0 };
                    });
                } else { mon.acts = []; }

                // ãƒ‰ãƒ­ãƒƒãƒ—ã®æ­£è¦åŒ– (drop -> drops)
                if (mon.drop && !mon.drops) {
                    mon.drops = { 
                        normal: { id: mon.drop.id, rate: mon.drop.rate }, 
                        rare: { id: null, rate: 0 } 
                    };
                    delete mon.drop;
                }
                if (!mon.drops) mon.drops = { normal: { id: null, rate: 0 }, rare: { id: null, rate: 0 } };
                if (!mon.drops.normal) mon.drops.normal = { id: null, rate: 0 };
                if (!mon.drops.rare) mon.drops.rare = { id: null, rate: 0 };

                // å„ç¨®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸåŒ–
                mon.elmRes = mon.elmRes || {}; 
                mon.resists = mon.resists || {}; 
                mon.traits = Array.isArray(mon.traits) ? mon.traits : [];
                mon.archives = Array.isArray(mon.archives) ? mon.archives : [];
                
                // ä¸è¶³æ•°å€¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè£œå®Œ
                const numericKeys = ["minF", "mdef", "hit", "eva", "cri", "rank", "exp", "gold", "actCount"];
                numericKeys.forEach(k => { if(mon[k] === undefined) mon[k] = 0; });
                if(!mon.actCount) mon.actCount = 1;

                return mon;
            });
            db.value.SKILLS = window.SKILLS_DATA || [];
            db.value.ITEMS = window.ITEMS_DATA || [];
        };

        onMounted(reloadData);

        const filteredMonsters = computed(() => {
            const q = monsterFilter.value.toLowerCase();
            return db.value.MONSTERS.filter(m => 
                (m.name && m.name.toLowerCase().includes(q)) || m.id.toString().includes(q)
            ).sort((a, b) => a.id - b.id);
        });

        const selectMonster = (m) => { selectedMonster.value = m; };

        const addMonster = () => {
            const maxId = Math.max(0, ...db.value.MONSTERS.map(m => m.id));
            const newM = {
                id: Math.floor(maxId) + 1, name: "New Monster", rank: 1, minF: 1, race: "ãªã—",
                hp: 100, mp: 0, atk: 10, def: 10, spd: 10, mag: 10, mdef: 10,
                hit: 100, eva: 0, cri: 0, gold: 10, exp: 10, actCount: 1,
                acts: [], drops: { normal: {id: null, rate: 0}, rare: {id: null, rate: 0} },
                elmRes: {}, resists: {}, traits: [], archives: [],
                isBoss: false, isRare: false, isEstark: false,
                _uid: Math.random().toString(36)
            };
            db.value.MONSTERS.push(newM);
            selectMonster(newM);
        };

        const duplicateMonster = () => {
            const copy = JSON.parse(JSON.stringify(selectedMonster.value));
            copy.id += 0.001; 
            copy.name += " (è¤‡å†™)"; 
            copy._uid = Math.random().toString(36);
            db.value.MONSTERS.push(copy);
            selectMonster(copy);
        };

        const removeMonster = () => {
            if (confirm("ã“ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                db.value.MONSTERS = db.value.MONSTERS.filter(m => m._uid !== selectedMonster.value._uid);
                selectedMonster.value = null;
            }
        };

        const addAct = () => { selectedMonster.value.acts.push({ id: 1, rate: 10, condition: 0 }); };
        
        const traitsString = computed(() => (selectedMonster.value?.traits || []).join(', '));
        const updateTraits = (val) => { selectedMonster.value.traits = val.split(',').map(s => s.trim()).filter(s => s !== ""); };
        
        const archivesString = computed(() => (selectedMonster.value?.archives || []).join(', '));
        const updateArchives = (val) => { selectedMonster.value.archives = val.split(',').map(s => s.trim()).filter(s => s !== ""); };

        const updateElmRes = (elm, val) => { selectedMonster.value.elmRes[elm] = Number(val); };
        const updateResist = (key, val) => { selectedMonster.value.resists[key] = Number(val); };

        const monsterDropNormalId = computed({ get: () => selectedMonster.value.drops.normal.id, set: (v) => selectedMonster.value.drops.normal.id = v });
        const monsterDropNormalRate = computed({ get: () => selectedMonster.value.drops.normal.rate, set: (v) => selectedMonster.value.drops.normal.rate = v });
        const monsterDropRareId = computed({ get: () => selectedMonster.value.drops.rare.id, set: (v) => selectedMonster.value.drops.rare.id = v });
        const monsterDropRareRate = computed({ get: () => selectedMonster.value.drops.rare.rate, set: (v) => selectedMonster.value.drops.rare.rate = v });

        // JSã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (Pretty vs Line)
        const downloadJS = (mode) => {
            const data = db.value.MONSTERS.map(m => { const { _uid, ...rest } = m; return rest; });
            if (mode === 'pretty') {
                exportText.value = `window.MONSTERS_DATA = ${JSON.stringify(data, null, 4)};`;
                exportModeName.value = "æ•´å½¢è¡¨ç¤º";
            } else {
                const rows = data.map(m => "    " + JSON.stringify(m)).join(",\n");
                exportText.value = `window.MONSTERS_DATA = [\n${rows}\n];`;
                exportModeName.value = "1IDã«ã¤ã1è¡Œ";
            }
            showExportArea.value = true;
        };

        const copyToClipboard = () => { navigator.clipboard.writeText(exportText.value); alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"); };

        // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ— (RFC4180)
        const escapeCSVCell = (val) => {
            let str = (val === null || val === undefined) ? "" : String(val);
            if (str.includes(",") || str.includes('"') || str.includes("\n") || str.includes("\r")) {
                str = '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        };

        const exportCSV = () => {
            const keys = ["id", "name", "race", "rank", "minF", "hp", "mp", "atk", "def", "spd", "mag", "mdef", "hit", "eva", "cri", "gold", "exp", "actCount", "isBoss", "isRare", "isEstark", "acts_json", "drops_json", "elmRes_json", "resists_json", "traits_json", "archives_json"];
            const headerRow = keys.join(",");
            const rows = db.value.MONSTERS.map(m => {
                const values = [
                    m.id, m.name, m.race, m.rank, m.minF, m.hp, m.mp, m.atk, m.def, m.spd, m.mag, m.mdef,
                    m.hit, m.eva, m.cri, m.gold, m.exp, m.actCount, m.isBoss, m.isRare, m.isEstark,
                    JSON.stringify(m.acts), JSON.stringify(m.drops), JSON.stringify(m.elmRes), JSON.stringify(m.resists), JSON.stringify(m.traits), JSON.stringify(m.archives)
                ];
                return values.map(escapeCSVCell).join(",");
            });
            const csvContent = headerRow + "\n" + rows.join("\n");
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "prisma_monsters_full_v43.csv";
            link.click();
        };

        const triggerCSVImport = () => {
            const input = document.createElement("input");
            input.type = "file"; input.accept = ".csv";
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const text = ev.target.result;
                    const rows = []; let cur = ""; let inQ = false; let row = [];
                    for(let i=0; i<text.length; i++){
                        const c = text[i];
                        if(inQ){
                            if(c==='"' && text[i+1]==='"'){ cur+='"'; i++; }
                            else if(c==='"') inQ=false;
                            else cur+=c;
                        } else {
                            if(c==='"') inQ=true;
                            else if(c===','){ row.push(cur); cur=""; }
                            else if(c==='\n'||c==='\r'){
                                row.push(cur); if(row.length>1) rows.push(row);
                                row=[]; cur=""; if(c==='\r'&&text[i+1]==='\n')i++;
                            } else cur+=c;
                        }
                    }
                    if(row.length>1){ row.push(cur); rows.push(row); }
                    if(rows.length < 2) return;
                    
                    const headers = rows[0];
                    db.value.MONSTERS = rows.slice(1).map(r => {
                        const m = {};
                        headers.forEach((h, idx) => {
                            let v = r[idx];
                            if(h.endsWith("_json")) {
                                try { m[h.replace("_json","")] = JSON.parse(v); } catch(e){ m[h.replace("_json","")]=[]; }
                            } else if(["isBoss","isRare","isEstark"].includes(h)) {
                                m[h] = (v === "true" || v === "TRUE");
                            } else {
                                m[h] = isNaN(v) || v==="" ? v : Number(v);
                            }
                        });
                        m._uid = Math.random().toString(36);
                        return m;
                    });
                    alert(`${db.value.MONSTERS.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        };

        return {
            db, selectedMonster, monsterFilter, filteredMonsters, activeTab, tabs, ailmentLabels, races,
            showExportArea, exportText, exportModeName, traitsString, archivesString,
            selectMonster, addMonster, duplicateMonster, removeMonster, addAct, updateTraits, updateArchives,
            monsterDropNormalId, monsterDropNormalRate, monsterDropRareId, monsterDropRareRate,
            updateElmRes, updateResist, downloadJS, copyToClipboard, exportCSV, triggerCSVImport, reloadData
        };
    }
}).mount('#app');
</script>
</body>
</html>